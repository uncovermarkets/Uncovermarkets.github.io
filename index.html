<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uncover Markets - Market Analysis & Insights</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Navigation */
        nav {
            background: #1e3a8a;
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        nav h1 {
            font-size: 1.5rem;
        }

        nav button, nav a {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
        }

        nav button:hover, nav a:hover {
            background: rgba(255,255,255,0.1);
        }

        /* User Badge */
        .user-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .badge-free {
            background: #6c757d;
            color: white;
        }

        .badge-subscriber {
            background: #28a745;
            color: white;
        }

        .badge-paid {
            background: #ffc107;
            color: #000;
        }

        .badge-admin {
            background: #dc3545;
            color: white;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 3rem 0;
            text-align: center;
        }

        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }

        /* Sections */
        section {
            padding: 2rem 0;
        }

        .section-title {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #1e3a8a;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .card h3 {
            color: #1e3a8a;
            margin-bottom: 0.5rem;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .article-card {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .article-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        /* Access Level Badges on Cards */
        .access-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .access-free {
            background: #e9ecef;
            color: #495057;
        }

        .access-subscriber {
            background: #d4edda;
            color: #155724;
        }

        .access-paid {
            background: #fff3cd;
            color: #856404;
        }

        /* Locked Content */
        .locked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 8px;
            text-align: center;
            padding: 2rem;
        }

        .locked-overlay h3 {
            color: white;
            margin-bottom: 1rem;
        }

        .locked-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group input[type="checkbox"],
        .form-group input[type="radio"],
        .form-group input[type="file"] {
            width: auto;
            margin-right: 0.5rem;
        }

        /* Toggle Tabs */
        .toggle-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #ddd;
        }

        .toggle-tab {
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #666;
        }

        .toggle-tab.active {
            color: #1e3a8a;
            border-bottom-color: #1e3a8a;
        }

        .toggle-content {
            display: none;
        }

        .toggle-content.active {
            display: block;
        }

        /* File Upload */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 0.75rem;
            background: #e9ecef;
            border: 2px dashed #1e3a8a;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-input-label:hover {
            background: #dee2e6;
        }

        .file-input-label.dragover {
            background: #d1ecf1;
            border-color: #0c5460;
        }

        .file-name {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .upload-progress {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .upload-progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }

        button[type="submit"], .btn-primary {
            background: #1e3a8a;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

        button[type="submit"]:hover, .btn-primary:hover {
            background: #2c5ba9;
        }

        button[type="submit"]:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 0.35rem 0.75rem;
            font-size: 0.85rem;
            width: auto;
            display: inline-block;
        }

        .form-link {
            text-align: center;
            margin-top: 1rem;
        }

        .form-link a {
            color: #1e3a8a;
            text-decoration: none;
        }

        .form-link a:hover {
            text-decoration: underline;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* About section */
        .about-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .about-section .icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Admin Panel Tabs */
        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 0.75rem 1.5rem;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .admin-tab.active {
            background: #1e3a8a;
            color: white;
        }

        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        /* User management */
        .user-card {
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 4px solid #1e3a8a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            flex: 1;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Alert/Message */
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Subscription Notice */
        .subscription-notice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem 0;
        }

        .subscription-notice h3 {
            color: white;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            nav .container {
                flex-direction: column;
                gap: 1rem;
            }

            .hero h2 {
                font-size: 1.8rem;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }

            .admin-tabs {
                flex-direction: column;
            }

            .user-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .user-actions {
                margin-top: 1rem;
                width: 100%;
            }

            .toggle-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="container">
            <h1>üìä Uncover Markets</h1>
            <div id="nav-buttons"></div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero">
        <div class="container">
            <h2>Welcome to Uncover Markets</h2>
            <p>Your source for stock market analysis and insights</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Subscription Notice (for non-paid users) -->
        <div id="subscription-notice" class="subscription-notice hidden">
            <div class="locked-icon">üîí</div>
            <h3>Upgrade to Paid Subscription</h3>
            <p>Get access to exclusive premium content, in-depth analysis, and expert insights.</p>
            <p><strong>Contact us at: uncover.markets@gmail.com</strong></p>
        </div>

        <!-- About Section -->
        <section id="about-section" class="about-section">
            <div class="icon">üë§</div>
            <h2>About Me</h2>
            <p id="intro-text">Use some description which we can change later - This is the default introduction text. You can update this by editing the admin panel.</p>
        </section>

        <!-- Newsletter Subscribe -->
        <section id="newsletter-subscribe" class="card">
            <h3>Subscribe to our newsletter for daily market insights, stock analysis, and investment tips directly in your inbox.</h3>
        </section>

        <!-- Latest Articles -->
        <section id="home-articles">
            <h2 class="section-title">Latest Articles</h2>
            <div id="home-articles-list" class="card-grid"></div>
        </section>

        <!-- All Articles Section (Hidden by default) -->
        <section id="articles-section" class="hidden">
            <h2 class="section-title">All Articles</h2>
            <div id="articles-list" class="card-grid"></div>
        </section>

        <!-- Newsletters Section (Hidden by default) -->
        <section id="newsletters-section" class="hidden">
            <h2 class="section-title">Newsletters</h2>
            <div id="newsletters-list" class="card-grid"></div>
        </section>

        <!-- Admin Panel (Hidden by default) -->
        <section id="admin-section" class="hidden">
            <h2 class="section-title">Admin Panel</h2>
            
            <!-- Admin Tabs -->
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('add-article')">Add Article</button>
                <button class="admin-tab" onclick="showAdminTab('add-newsletter')">Add Newsletter</button>
                <button class="admin-tab" onclick="showAdminTab('update-intro')">Update Introduction</button>
                <button class="admin-tab" onclick="showAdminTab('manage-users')">Manage Users</button>
                <button class="admin-tab" onclick="showAdminTab('manage-content')">Manage Content</button>
            </div>

            <!-- Add Article Tab -->
            <div id="add-article-tab" class="admin-content active card">
                <h3>Add New Article</h3>
                <form id="add-article-form">
                    <div class="form-group">
                        <label>Article Title</label>
                        <input type="text" id="article-title" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="article-category" required>
                            <option value="">Select Category</option>
                            <option value="Market Analysis">Market Analysis</option>
                            <option value="Daily News">Daily News</option>
                            <option value="Weekly News">Weekly News</option>
                            <option value="Sector Analysis">Sector Analysis</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Article Content</label>
                        <textarea id="article-content" placeholder="Write your article here..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label><strong>Access Level:</strong></label>
                        <div>
                            <label>
                                <input type="radio" name="article-access" value="free" checked>
                                Free (Everyone can access)
                            </label>
                        </div>
                        <div>
                            <label>
                                <input type="radio" name="article-access" value="subscriber">
                                Registered Subscribers Only
                            </label>
                        </div>
                        <div>
                            <label>
                                <input type="radio" name="article-access" value="paid">
                                Paid Subscribers Only
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Featured Image (Upload or paste URL)</label>
                        <input type="url" id="article-image" placeholder="https://example.com/image.jpg">
                    </div>
                    <button type="submit">Publish Article</button>
                </form>
            </div>

            <!-- Add Newsletter Tab -->
            <div id="add-newsletter-tab" class="admin-content card">
                <h3>Add New Newsletter</h3>
                <form id="add-newsletter-form">
                    <div class="form-group">
                        <label>Newsletter Title</label>
                        <input type="text" id="newsletter-title" required>
                    </div>
                    <div class="form-group">
                        <label>Newsletter Description</label>
                        <textarea id="newsletter-description" placeholder="Enter newsletter description..." required></textarea>
                    </div>

                    <!-- PDF Source Toggle -->
                    <div class="form-group">
                        <label><strong>PDF Source:</strong></label>
                        <div class="toggle-tabs">
                            <button type="button" class="toggle-tab active" onclick="togglePdfSource('upload')">Upload PDF</button>
                            <button type="button" class="toggle-tab" onclick="togglePdfSource('link')">Provide Link</button>
                        </div>
                    </div>

                    <!-- Upload PDF Option -->
                    <div id="pdf-upload-option" class="toggle-content active">
                        <div class="form-group">
                            <label>Upload PDF File</label>
                            <div class="file-input-wrapper">
                                <label for="newsletter-pdf-file" class="file-input-label" id="pdf-label">
                                    üìÅ Click to upload PDF or drag & drop
                                </label>
                                <input type="file" id="newsletter-pdf-file" accept=".pdf">
                                <div class="file-name" id="pdf-file-name"></div>
                                <div class="upload-progress hidden" id="pdf-progress">
                                    <div class="upload-progress-bar" id="pdf-progress-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Provide Link Option -->
                    <div id="pdf-link-option" class="toggle-content hidden">
                        <div class="form-group">
                            <label>PDF File URL</label>
                            <input type="url" id="newsletter-pdf-link" placeholder="https://example.com/newsletter.pdf" required>
                            <small style="color: #666; margin-top: 0.5rem; display: block;">Paste the URL of your PDF file (Google Drive, Dropbox, etc.)</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><strong>Access Level:</strong></label>
                        <div>
                            <label>
                                <input type="radio" name="newsletter-access" value="free" checked>
                                Free (Everyone can access)
                            </label>
                        </div>
                        <div>
                            <label>
                                <input type="radio" name="newsletter-access" value="subscriber">
                                Registered Subscribers Only
                            </label>
                        </div>
                        <div>
                            <label>
                                <input type="radio" name="newsletter-access" value="paid">
                                Paid Subscribers Only
                            </label>
                        </div>
                    </div>
                    <button type="submit" id="publish-newsletter-btn">Publish Newsletter</button>
                </form>
            </div>

            <!-- Update Introduction Tab -->
            <div id="update-intro-tab" class="admin-content card">
                <h3>Update Introduction</h3>
                <form id="update-intro-form">
                    <div class="form-group">
                        <label>Your Introduction Text</label>
                        <textarea id="intro-content" required></textarea>
                    </div>
                    <button type="submit">Update Introduction</button>
                </form>
            </div>

            <!-- Manage Users Tab -->
            <div id="manage-users-tab" class="admin-content card">
                <h3>Manage Users & Subscriptions</h3>
                <div class="alert alert-info">
                    <strong>User Levels:</strong><br>
                    ‚Ä¢ <strong>Registered:</strong> Can access subscriber-only content<br>
                    ‚Ä¢ <strong>Paid:</strong> Can access all premium content (requires your approval)
                </div>
                <div id="users-list"></div>
            </div>

            <!-- Manage Content Tab -->
            <div id="manage-content-tab" class="admin-content card">
                <h3>Manage Articles & Newsletters</h3>
                <h4>Articles</h4>
                <div id="manage-articles-list"></div>
                <h4 style="margin-top: 2rem;">Newsletters</h4>
                <div id="manage-newsletters-list"></div>
            </div>
        </section>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('login-modal')">&times;</span>
            <h2>Login</h2>
            <div id="login-message"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">Login</button>
                <div class="form-link">
                    Don't have an account? <a href="#" onclick="switchToRegister()">Register here</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('register-modal')">&times;</span>
            <h2>Create Account</h2>
            <div id="register-message"></div>
            <form id="register-form">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="register-phone" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="register-password" required minlength="6">
                </div>
                <button type="submit">Create Account</button>
                <div class="form-link">
                    Already have an account? <a href="#" onclick="switchToLogin()">Login here</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Article View Modal -->
    <div id="article-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('article-modal')">&times;</span>
            <div id="article-view"></div>
        </div>
    </div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        // ==========================================
        // FIREBASE INITIALIZATION
        // ==========================================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc,
            query,
            orderBy,
            limit,
            setDoc,
            getDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL,
            deleteObject
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAAgMmS-9XvwLyd85bGLMZvdQfM8mW1wzc",
            authDomain: "uncover-markets.firebaseapp.com",
            projectId: "uncover-markets",
            storageBucket: "uncover-markets.firebasestorage.app",
            messagingSenderId: "216882063477",
            appId: "1:216882063477:web:868356f7da4128df64703c",
            measurementId: "G-9PBZ62PMDW"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make available globally
        window.auth = auth;
        window.db = db;
        window.storage = storage;

        // Admin email
        const ADMIN_EMAIL = 'uncover.markets@gmail.com';
        
        // Current user state
        let currentUser = null;
        let isAdmin = false;
        let userLevel = 'free';
        let userData = null;

        // PDF source selection
        let selectedPdfSource = 'upload';
        let selectedPdfFile = null;

        // ==========================================
        // PDF SOURCE TOGGLE
        // ==========================================
        window.togglePdfSource = function(source) {
            selectedPdfSource = source;
            
            // Update button states
            document.querySelectorAll('.toggle-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Toggle content visibility
            if (source === 'upload') {
                document.getElementById('pdf-upload-option').classList.remove('hidden');
                document.getElementById('pdf-upload-option').classList.add('active');
                document.getElementById('pdf-link-option').classList.add('hidden');
                document.getElementById('pdf-link-option').classList.remove('active');
                document.getElementById('newsletter-pdf-link').removeAttribute('required');
            } else {
                document.getElementById('pdf-upload-option').classList.add('hidden');
                document.getElementById('pdf-upload-option').classList.remove('active');
                document.getElementById('pdf-link-option').classList.remove('hidden');
                document.getElementById('pdf-link-option').classList.add('active');
                document.getElementById('newsletter-pdf-link').setAttribute('required', 'required');
            }
            
            // Reset selections
            if (source === 'upload') {
                document.getElementById('newsletter-pdf-link').value = '';
            } else {
                selectedPdfFile = null;
                document.getElementById('newsletter-pdf-file').value = '';
                document.getElementById('pdf-file-name').textContent = '';
            }
        };

        // ==========================================
        // FILE UPLOAD HANDLERS
        // ==========================================
        const pdfInput = document.getElementById('newsletter-pdf-file');
        const pdfLabel = document.getElementById('pdf-label');
        const pdfFileName = document.getElementById('pdf-file-name');
        const pdfProgress = document.getElementById('pdf-progress');

        pdfInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });

        pdfLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            pdfLabel.classList.add('dragover');
        });

        pdfLabel.addEventListener('dragleave', () => {
            pdfLabel.classList.remove('dragover');
        });

        pdfLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            pdfLabel.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') {
                handleFileSelection(file);
            } else {
                alert('Please drop a PDF file');
            }
        });

        function handleFileSelection(file) {
            if (file.size > 100 * 1024 * 1024) {
                alert('File is too large. Maximum size is 100 MB.');
                return;
            }
            selectedPdfFile = file;
            pdfFileName.textContent = `üìÑ Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        }

        async function uploadPdfToStorage(file) {
            return new Promise((resolve, reject) => {
                const timestamp = Date.now();
                const fileName = `newsletters/${timestamp}-${file.name}`;
                const storageRef = ref(storage, fileName);
                const uploadTask = uploadBytesResumable(storageRef, file);

                pdfProgress.classList.remove('hidden');

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById('pdf-progress-bar').style.width = progress + '%';
                    },
                    (error) => {
                        pdfProgress.classList.add('hidden');
                        console.error('Upload error:', error);
                        reject(error);
                    },
                    async () => {
                        try {
                            const downloadUrl = await getDownloadURL(uploadTask.snapshot.ref);
                            pdfProgress.classList.add('hidden');
                            resolve(downloadUrl);
                        } catch (error) {
                            console.error('Error getting download URL:', error);
                            reject(error);
                        }
                    }
                );
            });
        }

        // ==========================================
        // AUTH STATE OBSERVER
        // ==========================================
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            isAdmin = user && user.email === ADMIN_EMAIL;
            
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    userLevel = userData.subscriptionLevel || 'subscriber';
                } else {
                    userLevel = 'subscriber';
                }
                
                if (isAdmin) {
                    userLevel = 'admin';
                }
                
                console.log('User signed in:', user.email, 'Level:', userLevel);
            } else {
                userLevel = 'free';
                userData = null;
                console.log('User signed out');
            }
            
            updateNavigation();
            await loadContent();
        });

        // ==========================================
        // NAVIGATION FUNCTIONS
        // ==========================================
        function updateNavigation() {
            const navButtons = document.getElementById('nav-buttons');
            
            if (currentUser) {
                let badge = '';
                if (isAdmin) {
                    badge = '<span class="user-badge badge-admin">ADMIN</span>';
                } else if (userLevel === 'paid') {
                    badge = '<span class="user-badge badge-paid">PAID</span>';
                } else if (userLevel === 'subscriber') {
                    badge = '<span class="user-badge badge-subscriber">SUBSCRIBER</span>';
                }
                
                navButtons.innerHTML = `
                    <div>
                        <a href="#" onclick="showHome()">Home</a>
                        <a href="#" onclick="showArticles()">Articles</a>
                        <a href="#" onclick="showNewsletters()">Newsletters</a>
                        ${isAdmin ? '<a href="#" onclick="showAdmin()">Admin</a>' : ''}
                    </div>
                    <div>
                        ${badge}
                        <button onclick="handleLogout()">Logout</button>
                    </div>
                `;
            } else {
                navButtons.innerHTML = `
                    <div>
                        <a href="#" onclick="showHome()">Home</a>
                        <button onclick="openModal('login-modal')">Login</button>
                        <button onclick="openModal('register-modal')">Register</button>
                    </div>
                `;
            }
        }

        // ==========================================
        // ACCESS CONTROL FUNCTIONS
        // ==========================================
        function canAccessContent(contentAccessLevel) {
            if (contentAccessLevel === 'free') return true;
            if (!currentUser) return false;
            if (isAdmin) return true;
            if (contentAccessLevel === 'subscriber') return userLevel === 'subscriber' || userLevel === 'paid';
            if (contentAccessLevel === 'paid') return userLevel === 'paid';
            return false;
        }

        function getAccessBadgeHTML(accessLevel) {
            const badges = {
                'free': '<span class="access-badge access-free">FREE</span>',
                'subscriber': '<span class="access-badge access-subscriber">SUBSCRIBERS</span>',
                'paid': '<span class="access-badge access-paid">PAID ONLY</span>'
            };
            return badges[accessLevel] || badges['free'];
        }

        function getLockedOverlayHTML(accessLevel) {
            const messages = {
                'subscriber': {
                    title: 'Subscribers Only',
                    message: 'Register and login to access this content',
                    action: 'openModal("register-modal")',
                    buttonText: 'Register Now'
                },
                'paid': {
                    title: 'Paid Subscribers Only',
                    message: 'Upgrade to paid subscription for exclusive premium content',
                    action: 'showSubscriptionNotice()',
                    buttonText: 'Learn More'
                }
            };
            
            const msg = messages[accessLevel];
            return `
                <div class="locked-overlay">
                    <div class="locked-icon">üîí</div>
                    <h3>${msg.title}</h3>
                    <p>${msg.message}</p>
                    <button class="btn-primary" onclick="${msg.action}">${msg.buttonText}</button>
                </div>
            `;
        }

        window.showSubscriptionNotice = function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('subscription-notice').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('subscription-notice').classList.add('hidden');
            }, 10000);
        };

        // ==========================================
        // MODAL FUNCTIONS
        // ==========================================
        window.openModal = function(modalId) {
            document.getElementById(modalId).classList.add('active');
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        window.switchToRegister = function() {
            closeModal('login-modal');
            openModal('register-modal');
        };

        window.switchToLogin = function() {
            closeModal('register-modal');
            openModal('login-modal');
        };

        // ==========================================
        // AUTHENTICATION HANDLERS
        // ==========================================
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const messageDiv = document.getElementById('login-message');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                messageDiv.innerHTML = '<div class="alert alert-success">Login successful!</div>';
                setTimeout(() => closeModal('login-modal'), 1000);
            } catch (error) {
                console.error('Login error:', error);
                messageDiv.innerHTML = `<div class="alert alert-error">Login failed: ${error.message}</div>`;
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const phone = document.getElementById('register-phone').value;
            const password = document.getElementById('register-password').value;
            const messageDiv = document.getElementById('register-message');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    name: name,
                    email: email,
                    phone: phone,
                    subscriptionLevel: 'subscriber',
                    registeredAt: new Date().toISOString(),
                    approvedAt: null
                });

                messageDiv.innerHTML = '<div class="alert alert-success">Registration successful! You now have access to subscriber content.</div>';
                setTimeout(() => closeModal('register-modal'), 2000);
            } catch (error) {
                console.error('Registration error:', error);
                messageDiv.innerHTML = `<div class="alert alert-error">Registration failed: ${error.message}</div>`;
            }
        });

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                showHome();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        };

        // ==========================================
        // NAVIGATION FUNCTIONS
        // ==========================================
        window.showHome = function() {
            document.getElementById('home-articles').classList.remove('hidden');
            document.getElementById('articles-section').classList.add('hidden');
            document.getElementById('newsletters-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('about-section').classList.remove('hidden');
            document.getElementById('newsletter-subscribe').classList.remove('hidden');
            loadHomeArticles();
        };

        window.showArticles = function() {
            document.getElementById('home-articles').classList.add('hidden');
            document.getElementById('articles-section').classList.remove('hidden');
            document.getElementById('newsletters-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('about-section').classList.add('hidden');
            document.getElementById('newsletter-subscribe').classList.add('hidden');
            loadAllArticles();
        };

        window.showNewsletters = function() {
            document.getElementById('home-articles').classList.add('hidden');
            document.getElementById('articles-section').classList.add('hidden');
            document.getElementById('newsletters-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('about-section').classList.add('hidden');
            document.getElementById('newsletter-subscribe').classList.add('hidden');
            loadNewsletters();
        };

        window.showAdmin = function() {
            if (!isAdmin) {
                alert('Access denied. Admin only.');
                return;
            }
            document.getElementById('home-articles').classList.add('hidden');
            document.getElementById('articles-section').classList.add('hidden');
            document.getElementById('newsletters-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            document.getElementById('about-section').classList.add('hidden');
            document.getElementById('newsletter-subscribe').classList.add('hidden');
            loadAdminContent();
        };

        // ==========================================
        // ADMIN TAB FUNCTIONS
        // ==========================================
        window.showAdminTab = function(tabName) {
            document.querySelectorAll('.admin-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'manage-users') {
                loadUsers();
            } else if (tabName === 'manage-content') {
                loadManageContent();
            } else if (tabName === 'update-intro') {
                loadCurrentIntro();
            }
        };

        // ==========================================
        // CONTENT LOADING FUNCTIONS
        // ==========================================
        async function loadContent() {
            await loadHomeArticles();
            await loadIntroduction();
        }

        async function loadHomeArticles() {
            const articlesDiv = document.getElementById('home-articles-list');
            articlesDiv.innerHTML = '<p>Loading articles...</p>';

            try {
                const q = query(collection(db, 'articles'), orderBy('createdAt', 'desc'), limit(6));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    articlesDiv.innerHTML = '<p>No articles available yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(docSnap => {
                    const article = docSnap.data();
                    const accessLevel = article.accessLevel || 'free';
                    const hasAccess = canAccessContent(accessLevel);
                    
                    html += `
                        <div class="card article-card" style="position: relative;" onclick="viewArticle('${docSnap.id}')">
                            ${getAccessBadgeHTML(accessLevel)}
                            <div class="article-meta">üì∞ ${article.category} | ${new Date(article.createdAt).toLocaleDateString()}</div>
                            <h3>${article.title}</h3>
                            <p>${article.content.substring(0, 100)}...</p>
                            ${!hasAccess ? getLockedOverlayHTML(accessLevel) : ''}
                        </div>
                    `;
                });
                
                articlesDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading articles:', error);
                articlesDiv.innerHTML = '<p>Error loading articles.</p>';
            }
        }

        async function loadAllArticles() {
            const articlesDiv = document.getElementById('articles-list');
            articlesDiv.innerHTML = '<p>Loading articles...</p>';

            try {
                const q = query(collection(db, 'articles'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    articlesDiv.innerHTML = '<p>No articles available yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(docSnap => {
                    const article = docSnap.data();
                    const accessLevel = article.accessLevel || 'free';
                    const hasAccess = canAccessContent(accessLevel);
                    
                    html += `
                        <div class="card article-card" style="position: relative;" onclick="viewArticle('${docSnap.id}')">
                            ${getAccessBadgeHTML(accessLevel)}
                            <div class="article-meta">üì∞ ${article.category} | ${new Date(article.createdAt).toLocaleDateString()}</div>
                            <h3>${article.title}</h3>
                            <p>${article.content.substring(0, 150)}...</p>
                            ${!hasAccess ? getLockedOverlayHTML(accessLevel) : ''}
                        </div>
                    `;
                });
                
                articlesDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading articles:', error);
                articlesDiv.innerHTML = '<p>Error loading articles.</p>';
            }
        }

        async function loadNewsletters() {
            const newslettersDiv = document.getElementById('newsletters-list');
            newslettersDiv.innerHTML = '<p>Loading newsletters...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'newsletters'));
                
                if (snapshot.empty) {
                    newslettersDiv.innerHTML = '<p>No newsletters available yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(docSnap => {
                    const newsletter = docSnap.data();
                    const accessLevel = newsletter.accessLevel || 'free';
                    const hasAccess = canAccessContent(accessLevel);
                    
                    if (hasAccess) {
                        html += `
                            <div class="card" style="position: relative;">
                                ${getAccessBadgeHTML(accessLevel)}
                                <h3>${newsletter.title}</h3>
                                <p>${newsletter.description}</p>
                                <a href="${newsletter.pdfUrl}" target="_blank" class="btn-primary" style="display:inline-block; text-align:center; text-decoration:none;">Download PDF</a>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="card" style="position: relative;">
                                ${getAccessBadgeHTML(accessLevel)}
                                <h3>${newsletter.title}</h3>
                                <p>${newsletter.description}</p>
                                ${getLockedOverlayHTML(accessLevel)}
                            </div>
                        `;
                    }
                });
                
                newslettersDiv.innerHTML = html || '<p>No newsletters available.</p>';
            } catch (error) {
                console.error('Error loading newsletters:', error);
                newslettersDiv.innerHTML = '<p>Error loading newsletters.</p>';
            }
        }

        async function loadIntroduction() {
            try {
                const docRef = doc(db, 'settings', 'introduction');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    document.getElementById('intro-text').textContent = docSnap.data().text;
                }
            } catch (error) {
                console.error('Error loading introduction:', error);
            }
        }

        window.viewArticle = async function(articleId) {
            try {
                const docRef = doc(db, 'articles', articleId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const article = docSnap.data();
                    const accessLevel = article.accessLevel || 'free';
                    const hasAccess = canAccessContent(accessLevel);
                    
                    if (!hasAccess) {
                        if (accessLevel === 'subscriber') {
                            openModal('register-modal');
                        } else if (accessLevel === 'paid') {
                            showSubscriptionNotice();
                        }
                        return;
                    }
                    
                    const articleView = document.getElementById('article-view');
                    
                    articleView.innerHTML = `
                        <h2>${article.title}</h2>
                        <div class="article-meta"><strong>Category:</strong> ${article.category}<br><strong>Date:</strong> ${new Date(article.createdAt).toLocaleDateString()}</div>
                        ${article.imageUrl ? `<img src="${article.imageUrl}" alt="${article.title}" style="max-width:100%; margin: 1rem 0;">` : ''}
                        <p style="white-space: pre-wrap;">${article.content}</p>
                    `;
                    
                    openModal('article-modal');
                }
            } catch (error) {
                console.error('Error loading article:', error);
                alert('Error loading article');
            }
        };

        // ==========================================
        // ADMIN FUNCTIONS
        // ==========================================
        async function loadAdminContent() {
            loadCurrentIntro();
        }

        async function loadCurrentIntro() {
            try {
                const docRef = doc(db, 'settings', 'introduction');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    document.getElementById('intro-content').value = docSnap.data().text;
                }
            } catch (error) {
                console.error('Error loading introduction:', error);
            }
        }

        async function loadUsers() {
            const usersDiv = document.getElementById('users-list');
            usersDiv.innerHTML = '<p>Loading users...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'users'));
                
                if (snapshot.empty) {
                    usersDiv.innerHTML = '<p>No registered users yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    const level = user.subscriptionLevel || 'subscriber';
                    const isPaid = level === 'paid';
                    
                    html += `
                        <div class="user-card">
                            <div class="user-info">
                                <strong>${user.name}</strong>
                                ${isPaid ? '<span class="user-badge badge-paid">PAID</span>' : '<span class="user-badge badge-subscriber">SUBSCRIBER</span>'}<br>
                                ${user.email}<br>
                                ${user.phone}<br>
                                <small>Registered: ${new Date(user.registeredAt).toLocaleString()}</small>
                                ${user.approvedAt ? `<br><small>Approved: ${new Date(user.approvedAt).toLocaleString()}</small>` : ''}
                            </div>
                            <div class="user-actions">
                                ${isPaid ? 
                                    `<button class="btn-secondary btn-small" onclick="revokeAccess('${docSnap.id}')">Revoke Paid</button>` :
                                    `<button class="btn-success btn-small" onclick="approvePaid('${docSnap.id}')">Approve as Paid</button>`
                                }
                            </div>
                        </div>
                    `;
                });
                
                usersDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading users:', error);
                usersDiv.innerHTML = '<p>Error loading users.</p>';
            }
        }

        window.approvePaid = async function(userId) {
            if (!isAdmin) return;
            
            if (confirm('Approve this user as a PAID subscriber? They will get access to all premium content.')) {
                try {
                    await updateDoc(doc(db, 'users', userId), {
                        subscriptionLevel: 'paid',
                        approvedAt: new Date().toISOString()
                    });
                    alert('User approved as paid subscriber!');
                    loadUsers();
                } catch (error) {
                    console.error('Error approving user:', error);
                    alert('Error approving user: ' + error.message);
                }
            }
        };

        window.revokeAccess = async function(userId) {
            if (!isAdmin) return;
            
            if (confirm('Revoke paid subscription? User will return to regular subscriber level.')) {
                try {
                    await updateDoc(doc(db, 'users', userId), {
                        subscriptionLevel: 'subscriber',
                        approvedAt: null
                    });
                    alert('Paid subscription revoked!');
                    loadUsers();
                } catch (error) {
                    console.error('Error revoking access:', error);
                    alert('Error revoking access: ' + error.message);
                }
            }
        };

        async function loadManageContent() {
            // Load articles
            const articlesDiv = document.getElementById('manage-articles-list');
            articlesDiv.innerHTML = '<p>Loading...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'articles'));
                
                if (snapshot.empty) {
                    articlesDiv.innerHTML = '<p>No articles to manage.</p>';
                } else {
                    let html = '';
                    snapshot.forEach(docSnap => {
                        const article = docSnap.data();
                        const accessLevel = article.accessLevel || 'free';
                        html += `
                            <div class="card">
                                <h4>${article.title}</h4>
                                <p>${article.category} | ${new Date(article.createdAt).toLocaleDateString()} | Access: <strong>${accessLevel.toUpperCase()}</strong></p>
                                <button class="btn-danger btn-small" onclick="deleteArticle('${docSnap.id}')">Delete</button>
                            </div>
                        `;
                    });
                    articlesDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading articles:', error);
            }

            // Load newsletters
            const newslettersDiv = document.getElementById('manage-newsletters-list');
            newslettersDiv.innerHTML = '<p>Loading...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'newsletters'));
                
                if (snapshot.empty) {
                    newslettersDiv.innerHTML = '<p>No newsletters to manage.</p>';
                } else {
                    let html = '';
                    snapshot.forEach(docSnap => {
                        const newsletter = docSnap.data();
                        const accessLevel = newsletter.accessLevel || 'free';
                        const isUploaded = newsletter.pdfUrl && newsletter.pdfUrl.includes('firebasestorage.googleapis.com');
                        html += `
                            <div class="card">
                                <h4>${newsletter.title}</h4>
                                <p>Access: <strong>${accessLevel.toUpperCase()}</strong> | ${isUploaded ? 'Uploaded' : 'External Link'}</p>
                                <button class="btn-danger btn-small" onclick="deleteNewsletter('${docSnap.id}')">Delete</button>
                            </div>
                        `;
                    });
                    newslettersDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading newsletters:', error);
            }
        }

        // ==========================================
        // ADMIN FORM HANDLERS
        // ==========================================
        document.getElementById('add-article-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            const title = document.getElementById('article-title').value;
            const category = document.getElementById('article-category').value;
            const content = document.getElementById('article-content').value;
            const accessLevel = document.querySelector('input[name="article-access"]:checked').value;
            const imageUrl = document.getElementById('article-image').value;

            try {
                await addDoc(collection(db, 'articles'), {
                    title,
                    category,
                    content,
                    accessLevel,
                    imageUrl,
                    createdAt: Date.now(),
                    author: currentUser.email
                });

                alert('Article published successfully!');
                e.target.reset();
                loadHomeArticles();
            } catch (error) {
                console.error('Error adding article:', error);
                alert('Error publishing article: ' + error.message);
            }
        });

        document.getElementById('add-newsletter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            const title = document.getElementById('newsletter-title').value;
            const description = document.getElementById('newsletter-description').value;
            const accessLevel = document.querySelector('input[name="newsletter-access"]:checked').value;
            const publishBtn = document.getElementById('publish-newsletter-btn');

            let pdfUrl = '';

            try {
                publishBtn.disabled = true;

                if (selectedPdfSource === 'upload') {
                    if (!selectedPdfFile) {
                        alert('Please select a PDF file to upload');
                        publishBtn.disabled = false;
                        return;
                    }
                    publishBtn.textContent = 'Uploading and publishing...';
                    pdfUrl = await uploadPdfToStorage(selectedPdfFile);
                } else {
                    const manualUrl = document.getElementById('newsletter-pdf-link').value;
                    if (!manualUrl) {
                        alert('Please provide a PDF URL');
                        publishBtn.disabled = false;
                        return;
                    }
                    publishBtn.textContent = 'Publishing...';
                    pdfUrl = manualUrl;
                }

                await addDoc(collection(db, 'newsletters'), {
                    title,
                    description,
                    pdfUrl,
                    accessLevel,
                    createdAt: Date.now(),
                    author: currentUser.email
                });

                alert('Newsletter published successfully!');
                
                // Reset form
                e.target.reset();
                selectedPdfFile = null;
                document.getElementById('pdf-file-name').textContent = '';
                document.getElementById('newsletter-pdf-file').value = '';
                document.getElementById('newsletter-pdf-link').value = '';
                publishBtn.disabled = false;
                publishBtn.textContent = 'Publish Newsletter';
                
                loadNewsletters();
            } catch (error) {
                console.error('Error adding newsletter:', error);
                alert('Error publishing newsletter: ' + error.message);
                publishBtn.disabled = false;
                publishBtn.textContent = 'Publish Newsletter';
            }
        });

        document.getElementById('update-intro-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            const text = document.getElementById('intro-content').value;

            try {
                await setDoc(doc(db, 'settings', 'introduction'), {
                    text,
                    updatedAt: Date.now()
                });

                alert('Introduction updated successfully!');
                loadIntroduction();
            } catch (error) {
                console.error('Error updating introduction:', error);
                alert('Error updating introduction: ' + error.message);
            }
        });

        window.deleteArticle = async function(articleId) {
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            if (confirm('Are you sure you want to delete this article?')) {
                try {
                    await deleteDoc(doc(db, 'articles', articleId));
                    alert('Article deleted successfully!');
                    loadManageContent();
                    loadHomeArticles();
                } catch (error) {
                    console.error('Error deleting article:', error);
                    alert('Error deleting article: ' + error.message);
                }
            }
        };

        window.deleteNewsletter = async function(newsletterId) {
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            if (confirm('Are you sure you want to delete this newsletter?')) {
                try {
                    const docRef = doc(db, 'newsletters', newsletterId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists() && docSnap.data().pdfUrl) {
                        const pdfUrl = docSnap.data().pdfUrl;
                        if (pdfUrl.includes('firebasestorage.googleapis.com')) {
                            try {
                                const fileRef = ref(storage, pdfUrl);
                                await deleteObject(fileRef);
                            } catch (err) {
                                console.warn('Could not delete PDF from storage:', err);
                            }
                        }
                    }
                    
                    await deleteDoc(docRef);
                    alert('Newsletter deleted successfully!');
                    loadManageContent();
                } catch (error) {
                    console.error('Error deleting newsletter:', error);
                    alert('Error deleting newsletter: ' + error.message);
                }
            }
        };

        // Initialize on load
        showHome();
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration);
                        setInterval(() => {
                            registration.update();
                        }, 60000);
                    })
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
