<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uncover Markets - Market Analysis & Insights</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Navigation */
        nav {
            background: #1e3a8a;
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        nav h1 {
            font-size: 1.5rem;
        }

        nav button, nav a {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
        }

        nav button:hover, nav a:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 3rem 0;
            text-align: center;
        }

        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }

        /* Sections */
        section {
            padding: 2rem 0;
        }

        .section-title {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #1e3a8a;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #1e3a8a;
            margin-bottom: 0.5rem;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .article-card {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .article-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        button[type="submit"], .btn-primary {
            background: #1e3a8a;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

        button[type="submit"]:hover, .btn-primary:hover {
            background: #2c5ba9;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .btn-danger {
            background: #dc3545;
        }

        .form-link {
            text-align: center;
            margin-top: 1rem;
        }

        .form-link a {
            color: #1e3a8a;
            text-decoration: none;
        }

        .form-link a:hover {
            text-decoration: underline;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* About section */
        .about-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .about-section .icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Admin Panel Tabs */
        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 0.75rem 1.5rem;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .admin-tab.active {
            background: #1e3a8a;
            color: white;
        }

        .admin-content {
            display: none;
        }

        .admin-content.active {
            display: block;
        }

        /* User management */
        .user-card {
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 4px solid #1e3a8a;
        }

        /* Alert/Message */
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Responsive */
        @media (max-width: 768px) {
            nav .container {
                flex-direction: column;
                gap: 1rem;
            }

            .hero h2 {
                font-size: 1.8rem;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="container">
            <h1>ðŸ“Š Uncover Markets</h1>
            <div id="nav-buttons"></div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero">
        <div class="container">
            <h2>Welcome to Uncover Markets</h2>
            <p>Your source for stock market analysis and insights</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- About Section -->
        <section id="about-section" class="about-section">
            <div class="icon">ðŸ‘¤</div>
            <h2>About Me</h2>
            <p id="intro-text">Use some description which we can change later - This is the default introduction text. You can update this by editing the admin panel.</p>
        </section>

        <!-- Newsletter Subscribe -->
        <section id="newsletter-subscribe" class="card">
            <h3>Subscribe to our newsletter for daily market insights, stock analysis, and investment tips directly in your inbox.</h3>
        </section>

        <!-- Latest Articles -->
        <section id="home-articles">
            <h2 class="section-title">Latest Articles</h2>
            <div id="home-articles-list" class="card-grid"></div>
        </section>

        <!-- All Articles Section (Hidden by default) -->
        <section id="articles-section" class="hidden">
            <h2 class="section-title">Articles</h2>
            <div id="articles-list" class="card-grid"></div>
        </section>

        <!-- Newsletters Section (Hidden by default) -->
        <section id="newsletters-section" class="hidden">
            <h2 class="section-title">Newsletters</h2>
            <div id="newsletters-list" class="card-grid"></div>
        </section>

        <!-- Admin Panel (Hidden by default) -->
        <section id="admin-section" class="hidden">
            <h2 class="section-title">Admin Panel</h2>
            
            <!-- Admin Tabs -->
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('add-article')">Add Article</button>
                <button class="admin-tab" onclick="showAdminTab('add-newsletter')">Add Newsletter</button>
                <button class="admin-tab" onclick="showAdminTab('update-intro')">Update Introduction</button>
                <button class="admin-tab" onclick="showAdminTab('view-users')">Registered Users</button>
                <button class="admin-tab" onclick="showAdminTab('manage-content')">Manage Content</button>
            </div>

            <!-- Add Article Tab -->
            <div id="add-article-tab" class="admin-content active card">
                <h3>Add New Article</h3>
                <form id="add-article-form">
                    <div class="form-group">
                        <label>Article Title</label>
                        <input type="text" id="article-title" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="article-category" required>
                            <option value="">Select Category</option>
                            <option value="Market Analysis">Market Analysis</option>
                            <option value="Daily News">Daily News</option>
                            <option value="Weekly News">Weekly News</option>
                            <option value="Sector Analysis">Sector Analysis</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Article Content</label>
                        <textarea id="article-content" placeholder="Write your article here..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="article-exclusive">
                            Mark as Exclusive (Registered Users Only)
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Featured Image (Upload or paste URL)</label>
                        <input type="url" id="article-image" placeholder="https://example.com/image.jpg">
                    </div>
                    <button type="submit">Publish Article</button>
                </form>
            </div>

            <!-- Add Newsletter Tab -->
            <div id="add-newsletter-tab" class="admin-content card">
                <h3>Add New Newsletter</h3>
                <form id="add-newsletter-form">
                    <div class="form-group">
                        <label>Newsletter Title</label>
                        <input type="text" id="newsletter-title" required>
                    </div>
                    <div class="form-group">
                        <label>Newsletter Description</label>
                        <textarea id="newsletter-description" placeholder="Enter newsletter description..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>PDF File (URL or upload)</label>
                        <input type="url" id="newsletter-pdf" placeholder="https://example.com/newsletter.pdf" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="newsletter-exclusive">
                            Mark as Exclusive
                        </label>
                    </div>
                    <button type="submit">Publish Newsletter</button>
                </form>
            </div>

            <!-- Update Introduction Tab -->
            <div id="update-intro-tab" class="admin-content card">
                <h3>Update Introduction</h3>
                <form id="update-intro-form">
                    <div class="form-group">
                        <label>Your Introduction Text</label>
                        <textarea id="intro-content" required></textarea>
                    </div>
                    <button type="submit">Update Introduction</button>
                </form>
            </div>

            <!-- View Users Tab -->
            <div id="view-users-tab" class="admin-content card">
                <h3>Registered Users</h3>
                <div id="users-list"></div>
            </div>

            <!-- Manage Content Tab -->
            <div id="manage-content-tab" class="admin-content card">
                <h3>Manage Articles & Newsletters</h3>
                <h4>Articles</h4>
                <div id="manage-articles-list"></div>
                <h4>Newsletters</h4>
                <div id="manage-newsletters-list"></div>
            </div>
        </section>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('login-modal')">&times;</span>
            <h2>Login</h2>
            <div id="login-message"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">Login</button>
                <div class="form-link">
                    Don't have an account? <a href="#" onclick="switchToRegister()">Register here</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('register-modal')">&times;</span>
            <h2>Create Account</h2>
            <div id="register-message"></div>
            <form id="register-form">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="register-phone" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="register-password" required minlength="6">
                </div>
                <button type="submit">Create Account</button>
                <div class="form-link">
                    Already have an account? <a href="#" onclick="switchToLogin()">Login here</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Article View Modal -->
    <div id="article-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('article-modal')">&times;</span>
            <div id="article-view"></div>
        </div>
    </div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        // ==========================================
        // FIREBASE INITIALIZATION - DO NOT MODIFY
        // ==========================================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc,
            query,
            orderBy,
            limit,
            setDoc,
            getDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your Firebase configuration (DO NOT CHANGE)
        const firebaseConfig = {
            apiKey: "AIzaSyAAgMmS-9XvwLyd85bGLMZvdQfM8mW1wzc",
            authDomain: "uncover-markets.firebaseapp.com",
            projectId: "uncover-markets",
            storageBucket: "uncover-markets.firebasestorage.app",
            messagingSenderId: "216882063477",
            appId: "1:216882063477:web:868356f7da4128df64703c",
            measurementId: "G-9PBZ62PMDW"
        };

        // Initialize Firebase - MUST BE FIRST
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make available globally for inline handlers
        window.auth = auth;
        window.db = db;

        // Admin email (change this to your email)
        const ADMIN_EMAIL = 'uncover.markets@gmail.com';
        
        // Current user state
        let currentUser = null;
        let isAdmin = false;

        // ==========================================
        // AUTH STATE OBSERVER
        // ==========================================
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            isAdmin = user && user.email === ADMIN_EMAIL;
            
            updateNavigation();
            
            if (user) {
                console.log('User signed in:', user.email);
                await loadContent();
            } else {
                console.log('User signed out');
                await loadContent();
            }
        });

        // ==========================================
        // NAVIGATION FUNCTIONS
        // ==========================================
        function updateNavigation() {
            const navButtons = document.getElementById('nav-buttons');
            
            if (currentUser) {
                navButtons.innerHTML = `
                    <a href="#" onclick="showHome()">Home</a>
                    <a href="#" onclick="showArticles()">Articles</a>
                    <a href="#" onclick="showNewsletters()">Newsletters</a>
                    ${isAdmin ? '<a href="#" onclick="showAdmin()">Admin</a>' : ''}
                    <button onclick="handleLogout()">Logout (${currentUser.email})</button>
                `;
            } else {
                navButtons.innerHTML = `
                    <a href="#" onclick="showHome()">Home</a>
                    <button onclick="openModal('login-modal')">Login</button>
                    <button onclick="openModal('register-modal')">Register</button>
                `;
            }
        }

        // ==========================================
        // MODAL FUNCTIONS
        // ==========================================
        window.openModal = function(modalId) {
            document.getElementById(modalId).classList.add('active');
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        window.switchToRegister = function() {
            closeModal('login-modal');
            openModal('register-modal');
        };

        window.switchToLogin = function() {
            closeModal('register-modal');
            openModal('login-modal');
        };

        // ==========================================
        // AUTHENTICATION HANDLERS
        // ==========================================
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const messageDiv = document.getElementById('login-message');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                messageDiv.innerHTML = '<div class="alert alert-success">Login successful!</div>';
                setTimeout(() => closeModal('login-modal'), 1000);
            } catch (error) {
                console.error('Login error:', error);
                messageDiv.innerHTML = `<div class="alert alert-error">Login failed: ${error.message}</div>`;
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const phone = document.getElementById('register-phone').value;
            const password = document.getElementById('register-password').value;
            const messageDiv = document.getElementById('register-message');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Store user data in Firestore
                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    name: name,
                    email: email,
                    phone: phone,
                    registeredAt: new Date().toLocaleString()
                });

                messageDiv.innerHTML = '<div class="alert alert-success">Registration successful!</div>';
                setTimeout(() => closeModal('register-modal'), 1000);
            } catch (error) {
                console.error('Registration error:', error);
                messageDiv.innerHTML = `<div class="alert alert-error">Registration failed: ${error.message}</div>`;
            }
        });

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                showHome();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        };

        // ==========================================
        // NAVIGATION FUNCTIONS
        // ==========================================
        window.showHome = function() {
            document.getElementById('home-articles').classList.remove('hidden');
            document.getElementById('articles-section').classList.add('hidden');
            document.getElementById('newsletters-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('about-section').classList.remove('hidden');
            document.getElementById('newsletter-subscribe').classList.remove('hidden');
            loadHomeArticles();
        };

        window.showArticles = function() {
            document.getElementById('home-articles').classList.add('hidden');
            document.getElementById('articles-section').classList.remove('hidden');
            document.getElementById('newsletters-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('about-section').classList.add('hidden');
            document.getElementById('newsletter-subscribe').classList.add('hidden');
            loadAllArticles();
        };

        window.showNewsletters = function() {
            document.getElementById('home-articles').classList.add('hidden');
            document.getElementById('articles-section').classList.add('hidden');
            document.getElementById('newsletters-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('about-section').classList.add('hidden');
            document.getElementById('newsletter-subscribe').classList.add('hidden');
            loadNewsletters();
        };

        window.showAdmin = function() {
            if (!isAdmin) {
                alert('Access denied. Admin only.');
                return;
            }
            document.getElementById('home-articles').classList.add('hidden');
            document.getElementById('articles-section').classList.add('hidden');
            document.getElementById('newsletters-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            document.getElementById('about-section').classList.add('hidden');
            document.getElementById('newsletter-subscribe').classList.add('hidden');
            loadAdminContent();
        };

        // ==========================================
        // ADMIN TAB FUNCTIONS
        // ==========================================
        window.showAdminTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.admin-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'view-users') {
                loadUsers();
            } else if (tabName === 'manage-content') {
                loadManageContent();
            } else if (tabName === 'update-intro') {
                loadCurrentIntro();
            }
        };

        // ==========================================
        // CONTENT LOADING FUNCTIONS
        // ==========================================
        async function loadContent() {
            await loadHomeArticles();
            await loadIntroduction();
        }

        async function loadHomeArticles() {
            const articlesDiv = document.getElementById('home-articles-list');
            articlesDiv.innerHTML = '<p>Loading articles...</p>';

            try {
                const q = query(collection(db, 'articles'), orderBy('createdAt', 'desc'), limit(6));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    articlesDiv.innerHTML = '<p>No articles available yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const article = doc.data();
                    if (!article.exclusive || currentUser) {
                        html += `
                            <div class="card article-card" onclick="viewArticle('${doc.id}')">
                                <div class="article-meta">ðŸ“° ${article.category} | ${new Date(article.createdAt).toLocaleDateString()}</div>
                                <h3>${article.title}</h3>
                                <p>${article.content.substring(0, 100)}...</p>
                            </div>
                        `;
                    }
                });
                
                articlesDiv.innerHTML = html || '<p>No articles available.</p>';
            } catch (error) {
                console.error('Error loading articles:', error);
                articlesDiv.innerHTML = '<p>Error loading articles.</p>';
            }
        }

        async function loadAllArticles() {
            const articlesDiv = document.getElementById('articles-list');
            articlesDiv.innerHTML = '<p>Loading articles...</p>';

            try {
                const q = query(collection(db, 'articles'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    articlesDiv.innerHTML = '<p>No articles available yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const article = doc.data();
                    if (!article.exclusive || currentUser) {
                        html += `
                            <div class="card article-card" onclick="viewArticle('${doc.id}')">
                                <div class="article-meta">ðŸ“° ${article.category} | ${new Date(article.createdAt).toLocaleDateString()}</div>
                                <h3>${article.title}</h3>
                                <p>${article.content.substring(0, 150)}...</p>
                            </div>
                        `;
                    }
                });
                
                articlesDiv.innerHTML = html || '<p>No articles available.</p>';
            } catch (error) {
                console.error('Error loading articles:', error);
                articlesDiv.innerHTML = '<p>Error loading articles.</p>';
            }
        }

        async function loadNewsletters() {
            const newslettersDiv = document.getElementById('newsletters-list');
            newslettersDiv.innerHTML = '<p>Loading newsletters...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'newsletters'));
                
                if (snapshot.empty) {
                    newslettersDiv.innerHTML = '<p>No newsletters available yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const newsletter = doc.data();
                    if (!newsletter.exclusive || currentUser) {
                        html += `
                            <div class="card">
                                <h3>${newsletter.title}</h3>
                                <p>${newsletter.description}</p>
                                <a href="${newsletter.pdfUrl}" target="_blank" class="btn-primary" style="display:inline-block; text-align:center; text-decoration:none;">Download PDF</a>
                            </div>
                        `;
                    }
                });
                
                newslettersDiv.innerHTML = html || '<p>No newsletters available.</p>';
            } catch (error) {
                console.error('Error loading newsletters:', error);
                newslettersDiv.innerHTML = '<p>Error loading newsletters.</p>';
            }
        }

        async function loadIntroduction() {
            try {
                const docRef = doc(db, 'settings', 'introduction');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    document.getElementById('intro-text').textContent = docSnap.data().text;
                }
            } catch (error) {
                console.error('Error loading introduction:', error);
            }
        }

        window.viewArticle = async function(articleId) {
            try {
                const docRef = doc(db, 'articles', articleId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const article = docSnap.data();
                    const articleView = document.getElementById('article-view');
                    
                    articleView.innerHTML = `
                        <h2>${article.title}</h2>
                        <div class="article-meta"><strong>Category:</strong> ${article.category}<br><strong>Date:</strong> ${new Date(article.createdAt).toLocaleDateString()}</div>
                        ${article.imageUrl ? `<img src="${article.imageUrl}" alt="${article.title}" style="max-width:100%; margin: 1rem 0;">` : ''}
                        <p style="white-space: pre-wrap;">${article.content}</p>
                    `;
                    
                    openModal('article-modal');
                }
            } catch (error) {
                console.error('Error loading article:', error);
                alert('Error loading article');
            }
        };

        // ==========================================
        // ADMIN FUNCTIONS
        // ==========================================
        async function loadAdminContent() {
            loadCurrentIntro();
        }

        async function loadCurrentIntro() {
            try {
                const docRef = doc(db, 'settings', 'introduction');
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    document.getElementById('intro-content').value = docSnap.data().text;
                }
            } catch (error) {
                console.error('Error loading introduction:', error);
            }
        }

        async function loadUsers() {
            const usersDiv = document.getElementById('users-list');
            usersDiv.innerHTML = '<p>Loading users...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'users'));
                
                if (snapshot.empty) {
                    usersDiv.innerHTML = '<p>No registered users yet.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <div class="user-card">
                            <strong>${user.name}</strong><br>
                            ${user.email}<br>
                            ${user.phone}<br>
                            <small>Registered: ${user.registeredAt}</small>
                        </div>
                    `;
                });
                
                usersDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading users:', error);
                usersDiv.innerHTML = '<p>Error loading users.</p>';
            }
        }

        async function loadManageContent() {
            // Load articles
            const articlesDiv = document.getElementById('manage-articles-list');
            articlesDiv.innerHTML = '<p>Loading...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'articles'));
                
                if (snapshot.empty) {
                    articlesDiv.innerHTML = '<p>No articles to manage.</p>';
                } else {
                    let html = '';
                    snapshot.forEach(doc => {
                        const article = doc.data();
                        html += `
                            <div class="card">
                                <h4>${article.title}</h4>
                                <p>${article.category} | ${new Date(article.createdAt).toLocaleDateString()}</p>
                                <button class="btn-danger" onclick="deleteArticle('${doc.id}')">Delete</button>
                            </div>
                        `;
                    });
                    articlesDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading articles:', error);
            }

            // Load newsletters
            const newslettersDiv = document.getElementById('manage-newsletters-list');
            newslettersDiv.innerHTML = '<p>Loading...</p>';

            try {
                const snapshot = await getDocs(collection(db, 'newsletters'));
                
                if (snapshot.empty) {
                    newslettersDiv.innerHTML = '<p>No newsletters to manage.</p>';
                } else {
                    let html = '';
                    snapshot.forEach(doc => {
                        const newsletter = doc.data();
                        html += `
                            <div class="card">
                                <h4>${newsletter.title}</h4>
                                <button class="btn-danger" onclick="deleteNewsletter('${doc.id}')">Delete</button>
                            </div>
                        `;
                    });
                    newslettersDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading newsletters:', error);
            }
        }

        // ==========================================
        // ADMIN FORM HANDLERS
        // ==========================================
        document.getElementById('add-article-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            const title = document.getElementById('article-title').value;
            const category = document.getElementById('article-category').value;
            const content = document.getElementById('article-content').value;
            const exclusive = document.getElementById('article-exclusive').checked;
            const imageUrl = document.getElementById('article-image').value;

            try {
                await addDoc(collection(db, 'articles'), {
                    title,
                    category,
                    content,
                    exclusive,
                    imageUrl,
                    createdAt: Date.now(),
                    author: currentUser.email
                });

                alert('Article published successfully!');
                e.target.reset();
                loadHomeArticles();
            } catch (error) {
                console.error('Error adding article:', error);
                alert('Error publishing article: ' + error.message);
            }
        });

        document.getElementById('add-newsletter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            const title = document.getElementById('newsletter-title').value;
            const description = document.getElementById('newsletter-description').value;
            const pdfUrl = document.getElementById('newsletter-pdf').value;
            const exclusive = document.getElementById('newsletter-exclusive').checked;

            try {
                await addDoc(collection(db, 'newsletters'), {
                    title,
                    description,
                    pdfUrl,
                    exclusive,
                    createdAt: Date.now(),
                    author: currentUser.email
                });

                alert('Newsletter published successfully!');
                e.target.reset();
            } catch (error) {
                console.error('Error adding newsletter:', error);
                alert('Error publishing newsletter: ' + error.message);
            }
        });

        document.getElementById('update-intro-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            const text = document.getElementById('intro-content').value;

            try {
                await setDoc(doc(db, 'settings', 'introduction'), {
                    text,
                    updatedAt: Date.now()
                });

                alert('Introduction updated successfully!');
                loadIntroduction();
            } catch (error) {
                console.error('Error updating introduction:', error);
                alert('Error updating introduction: ' + error.message);
            }
        });

        window.deleteArticle = async function(articleId) {
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            if (confirm('Are you sure you want to delete this article?')) {
                try {
                    await deleteDoc(doc(db, 'articles', articleId));
                    alert('Article deleted successfully!');
                    loadManageContent();
                    loadHomeArticles();
                } catch (error) {
                    console.error('Error deleting article:', error);
                    alert('Error deleting article: ' + error.message);
                }
            }
        };

        window.deleteNewsletter = async function(newsletterId) {
            if (!isAdmin) {
                alert('Admin access required');
                return;
            }

            if (confirm('Are you sure you want to delete this newsletter?')) {
                try {
                    await deleteDoc(doc(db, 'newsletters', newsletterId));
                    alert('Newsletter deleted successfully!');
                    loadManageContent();
                } catch (error) {
                    console.error('Error deleting newsletter:', error);
                    alert('Error deleting newsletter: ' + error.message);
                }
            }
        };

        // Initialize on load
        showHome();
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration);
                        // Check for updates every 60 seconds
                        setInterval(() => {
                            registration.update();
                        }, 60000);
                    })
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
